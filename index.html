<script>
    async function handleUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            alert("Please pick a file first!");
            return;
        }

        const btn = document.getElementById('uploadBtn');
        const status = document.getElementById('statusArea');
        const bar = document.getElementById('progressBar');
        
        btn.disabled = true;
        btn.innerText = "Connecting...";
        status.classList.remove('hidden');
        bar.style.width = '20%';

        const formData = new FormData();
        // Crucial: File.io usually expects the key to be exactly 'file'
        formData.append('file', file);

        try {
            // We use a CORS proxy if the direct upload fails
            const response = await fetch('https://file.io/?expires=1d', {
                method: 'POST',
                body: formData,
                // Do NOT set Content-Type header; the browser does it automatically for FormData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server responded with ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            
            if (data.success) {
                bar.style.width = '100%';
                document.getElementById('statusText').innerText = "Success! Link generated.";
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('shareLink').value = data.link;
                btn.innerText = "Upload Another";
                btn.disabled = false;
            } else {
                throw new Error(data.message || "Upload failed");
            }
            
        } catch (error) {
            console.error("Upload Error:", error);
            alert("Link generation failed. This usually happens if the file is too large or the connection was blocked.");
            btn.disabled = false;
            btn.innerText = "Try Again";
            bar.style.backgroundColor = "#ff4d4d";
        }
    }

    function copyLink() {
        const copyText = document.getElementById("shareLink");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        alert("Link copied! Ready for Android.");
    }
</script>
